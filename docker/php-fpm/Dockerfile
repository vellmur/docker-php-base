FROM php:8.1.7-fpm-alpine

# Install packages
RUN apk add --no-cache curl git build-base zlib-dev oniguruma-dev autoconf bash

# Install xdebug on specific environments
ARG INSTALL_XDEBUG=false
RUN if [ ${INSTALL_XDEBUG} = true ]; \
    then \
        apk add --update linux-headers && pecl install xdebug && docker-php-ext-enable xdebug; \
    fi;

COPY ./docker/php-fpm/xdebug.ini /usr/local/etc/php/conf.d/xdebug.ini
COPY ./docker/php-fpm/php.ini /usr/local/etc/php/conf.d/php.ini

# Configure non-root user
ARG PUID=1000
ARG PGID=1000

RUN apk --no-cache add shadow && \
    groupmod -o -g ${PGID} www-data && \
    usermod -o -u ${PUID} -g www-data www-data

# Mysql
#RUN docker-php-ext-install pdo_mysql
RUN docker-php-ext-install mysqli pdo pdo_mysql && docker-php-ext-enable pdo_mysql

# Source code
COPY ./ /var/www
WORKDIR /var/www

# Composer install
COPY --from=composer:latest /usr/bin/composer /usr/bin/composer

# Run php-fpm on 9000 port
CMD php-fpm
EXPOSE 9000